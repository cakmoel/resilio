name: Branch Protection Setup

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
        - apply
        - verify
        - help
      owner:
        description: 'Repository owner (defaults to current)'
        required: false
        type: string
      repo:
        description: 'Repository name (defaults to current)'
        required: false
        type: string

jobs:
  branch-protection:
    runs-on: ubuntu-latest
    if: github.repository_owner == github.actor  # Only allow repo owner
    
    permissions:
      contents: write
      administration: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Apply Branch Protection
        if: github.event.inputs.action == 'apply'
        run: |
          OWNER="${{ github.event.inputs.owner || github.repository_owner }}"
          REPO="${{ github.event.inputs.repo || github.event.repository }}"
          
          echo "Applying branch protection to ${OWNER}/${REPO}"
          
          PROTECTION_CONFIG='{
            "required_status_checks": {
              "strict": true,
              "contexts": ["CI"]
            },
            "enforce_admins": true,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true,
              "require_code_owner_reviews": false,
              "require_last_push_approval": false
            },
            "restrictions": null,
            "allow_force_pushes": false,
            "allow_deletions": false,
            "required_linear_history": true,
            "allow_fork_syncing": false
          }'
          
          gh api \
            --method PUT \
            "repos/${OWNER}/${REPO}/branches/main/protection" \
            --header "Accept: application/vnd.github.v3+json" \
            --field "required_status_checks=$(echo "$PROTECTION_CONFIG" | jq '.required_status_checks')" \
            --field "enforce_admins=$(echo "$PROTECTION_CONFIG" | jq '.enforce_admins')" \
            --field "required_pull_request_reviews=$(echo "$PROTECTION_CONFIG" | jq '.required_pull_request_reviews')" \
            --field "restrictions=$(echo "$PROTECTION_CONFIG" | jq '.restrictions')" \
            --field "allow_force_pushes=$(echo "$PROTECTION_CONFIG" | jq '.allow_force_pushes')" \
            --field "allow_deletions=$(echo "$PROTECTION_CONFIG" | jq '.allow_deletions')" \
            --field "required_linear_history=$(echo "$PROTECTION_CONFIG" | jq '.required_linear_history')" \
            --field "allow_fork_syncing=$(echo "$PROTECTION_CONFIG" | jq '.allow_fork_syncing')"

      - name: Verify Branch Protection
        if: github.event.inputs.action == 'verify'
        run: |
          OWNER="${{ github.event.inputs.owner || github.repository_owner }}"
          REPO="${{ github.event.inputs.repo || github.event.repository }}"
          
          echo "Verifying branch protection for ${OWNER}/${REPO}"
          
          if PROTECTION_STATUS=$(gh api "repos/${OWNER}/${REPO}/branches/main/protection" 2>/dev/null); then
            echo "âœ… Branch protection is enabled"
            echo "$PROTECTION_STATUS" | jq '{
              required_status_checks: .required_status_checks,
              enforce_admins: .enforce_admins,
              required_pull_request_reviews: .required_pull_request_reviews,
              allow_force_pushes: .allow_force_pushes,
              allow_deletions: .allow_deletions,
              required_linear_history: .required_linear_history
            }'
            
            # Check critical security settings
            ENFORCE_ADMINS=$(echo "$PROTECTION_STATUS" | jq -r '.enforce_admins')
            REQUIRED_REVIEWS=$(echo "$PROTECTION_STATUS" | jq -r '.required_pull_request_reviews.required_approving_review_count')
            STRICT_CHECKS=$(echo "$PROTECTION_STATUS" | jq -r '.required_status_checks.strict')
            
            echo ""
            echo "ðŸ”’ Security Audit:"
            if [[ "$ENFORCE_ADMINS" == "true" ]]; then
              echo "âœ… Admin enforcement enabled"
            else
              echo "âŒ Admin enforcement disabled"
            fi
            
            if [[ "$REQUIRED_REVIEWS" == "1" ]]; then
              echo "âœ… PR reviews required"
            else
              echo "âŒ PR reviews not required"
            fi
            
            if [[ "$STRICT_CHECKS" == "true" ]]; then
              echo "âœ… Strict CI checks enabled"
            else
              echo "âŒ Strict CI checks disabled"
            fi
          else
            echo "âŒ No branch protection found on main branch"
          fi

      - name: Show Help
        if: github.event.inputs.action == 'help'
        run: |
          echo "# Branch Protection Help"
          echo ""
          echo "## Usage:"
          echo "1. Go to Actions tab in GitHub"
          echo "2. Select 'Branch Protection Setup' workflow"
          echo "3. Click 'Run workflow'"
          echo "4. Choose action: 'apply' or 'verify'"
          echo "5. (Optional) Enter custom owner/repo"
          echo ""
          echo "## Applied Rules:"
          echo "- âœ… Required status checks (CI) with strict mode"
          echo "- âœ… Admin enforcement (no bypass)"
          echo "- âœ… 1 required PR review approval"
          echo "- âœ… Dismiss stale reviews"
          echo "- âœ… Linear history required"
          echo "- âŒ Force pushes disabled"
          echo "- âŒ Branch deletion disabled"
          echo ""
          echo "## Manual Setup:"
          echo "Go to Settings > Branches > Add rule and configure as above"
          echo ""
          echo "## Security Notes:"
          echo "- Only repository admins can run this workflow"
          echo "- Rules apply to ALL contributors including admins"
          echo "- Keep CI healthy to avoid merge blocks"