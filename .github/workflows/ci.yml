name: CI

on:
  push:
    branches: [ "main", "feat/dlt-v6.2" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bats shellcheck apache2-utils bc
          
          # Debug: Show tool versions
          echo "=== Tool Versions ==="
          bats --version
          shellcheck --version
          python3 --version
          ab -V 2>&1 | head -1
          echo "====================="

      - name: Lint (ShellCheck)
        run: |
          shellcheck -x -e SC2006 bin/dlt.sh bin/slt.sh lib/normality.sh lib/parser.sh lib/report.sh lib/runner.sh lib/stats.sh lib/workload.sh lib/kernel_metrics.sh lib/gregg_profiling.sh config/dlt.conf

      - name: Python Unit Tests
        run: |
          python3 tests/unit/test_stats.py

      - name: Unit tests (Bats)
        run: |
          export BASE_DIR=$GITHUB_WORKSPACE
          echo "Running unit tests with BASE_DIR: $BASE_DIR"
          
          # Ensure scripts are executable
          chmod +x bin/*.sh lib/*.sh 2>/dev/null || true
          
          # Run tests with retry for intermittent issues
          for attempt in {1..3}; do
            echo "Test attempt $attempt:"
            if make test-unit; then
              echo "✅ All tests passed on attempt $attempt"
              break
            elif [ $attempt -eq 3 ]; then
              echo "❌ Tests failed after 3 attempts"
              exit 1
            else
              echo "⚠️  Tests failed, retrying in 2 seconds..."
              sleep 2
            fi
          done
